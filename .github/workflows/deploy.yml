Deploy-To-VM:
  needs: Build-and-Push
  runs-on: ubuntu-latest

  steps:
  - name: Create SSH key file
    run: |
      echo "${{ secrets.SSH_PRIVATE_KEY }}" > private_key.pem
      chmod 600 private_key.pem

  - name: Deploy Docker Container on Azure VM
    run: |
      ssh -o StrictHostKeyChecking=no -i private_key.pem azureuser@40.82.207.123 << 'EOF'

      # Ensure Docker is installed
      sudo apt update && sudo apt install -y docker.io
      # Stop and remove any existing container
      docker stop my-web-app || true
      docker rm my-web-app || true
      # Pull the latest Docker image from Docker Hub
      docker pull 20059516/my-web-app:${{ github.sha }}
      # Run the Docker container
      docker run -d -p 80:80 --name my-web-app 20059516/my-web-app:${{ github.sha }}

      EOF
